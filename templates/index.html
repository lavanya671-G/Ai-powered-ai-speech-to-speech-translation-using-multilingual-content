<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>üé¨ AI Multilingual Video Translator</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#0d0d0f; --card:#1a1a1d; --muted:#aaa; --accent:#00c3ff; --success:#00b894; --danger:#ff4757;
  }
  html,body{
    height:100%;margin:0;font-family:"Segoe UI",Arial,sans-serif;background:var(--bg);color:#eee
  }
  header{
    display:flex;align-items:center;justify-content:space-between;padding:14px 28px;background:#161618;border-bottom:1px solid #222;position:sticky;top:0;z-index:40
  }
  header h2{
    margin:0;color:var(--accent);font-weight:700;text-shadow:0 0 12px rgba(0,195,255,0.6)
  }
  .mic-wrap{
    display:flex;gap:10px;align-items:center
  }
  .mic-wrap select,.mic-wrap button{
    padding:8px 10px;border-radius:8px;border:none;background:#1f1f21;color:#fff;font-weight:600;cursor:pointer
  }
  #micBtn{
    background:var(--danger)
  }
  main{
    padding:40px;max-width:1500px;margin:auto
  }
  h2.section-title{
    font-size:26px;margin-bottom:20px;color:var(--accent);display:flex;align-items:center;gap:10px
  }
  #originalVideosWrapper,#translatedList{
    display:grid;grid-template-columns:repeat(auto-fit,minmax(330px,1fr));gap:30px
  }
  .card{
    background:var(--card);border-radius:14px;padding:12px;position:relative;box-shadow:0 6px 20px rgba(0,0,0,0.55);transition:transform .18s
  }
  .card:hover{
    transform:translateY(-4px)
  }
  video{
    width:100%;border-radius:12px;background:#000;outline:none;display:block
  }
  .controls{
    margin-top:10px;display:flex;justify-content:space-between;gap:10px
  }
  .controls select,.controls button.translate{
    padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600
  }
  button.translate{
    background:#007bff;color:#fff
  }
  /* bottom-right dots */
  .dots{
    position:absolute;bottom:12px;right:12px;font-size:26px;cursor:pointer;user-select:none;color:#ffffffc0;z-index:30
  }
  .dots:hover{
    color:#fff
  }
  .menu-box{
    display:none;position:absolute;bottom:50px;right:12px;width:220px;background:#222;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,0.6);overflow:hidden;animation:fadeIn .14s ease;z-index:50
  }
  @keyframes fadeIn{from{
    opacity:0;transform:translateY(8px)}to{opacity:1;transform:none
    }}
  .menu-item{
    padding:12px 14px;display:flex;align-items:center;gap:10px;cursor:pointer;color:#eee;font-size:15px
  }
  .menu-item:hover{
    background:#333
  }
  .submenu{
    display:none;position:absolute;bottom:50px;right:244px;width:160px;background:#222;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,0.6);overflow:hidden;z-index:60
  }
  .submenu .menu-item{
    padding:10px 12px
  }
  .overlay{
    position:fixed;inset:0;background:rgba(0,0,0,0.75);display:none;align-items:center;justify-content:center;z-index:999
  }
  .overlay.show{
    display:flex
  }
  .notification{
    position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:8px;color:#fff;opacity:0;transform:translateX(100%);transition:all .25s;z-index:1000;font-weight:600
  }
  .notification.show{
    opacity:1;transform:translateX(0)
  }
  /* make selects show fully above overlays */
  select{z-index:100}
  /* responsive tweaks */
  @media (max-width:480px){
    header{padding:10px}
    main{padding:18px}
    .menu-box{right:8px;width:180px}
    .submenu{right:196px}
  }
</style>
</head>
<body>

<header>
  <h2>üé¨ AI Multilingual Video Translator</h2>

  <div class="mic-wrap" role="region" aria-label="mic controls">
    <label style="color:var(--muted);font-size:13px;margin-right:6px">Mic ‚Üí</label>
    <select id="micLangSelect" aria-label="choose mic translate language">
      <option value="hi">Hindi</option>
      <option value="en">English</option>
      <option value="fr">French</option>
      <option value="es">Spanish</option>
      <option value="de">German</option>
      <option value="it">Italian</option>
      <option value="ru">Russian</option>
      <option value="ar">Arabic</option>
      <option value="zh">Chinese</option>
      <option value="nl">Dutch</option>
      <option value="pt">Portuguese</option>
      <option value="ja">Japanese</option>
      <option value="ko">Korean</option>
    </select>
    <button id="micBtn" aria-label="record mic for translation">üé§ Mic Translate</button>
  </div>
</header>

<main>
  <h2 class="section-title">üé¨ Original Videos</h2>
  <div id="originalVideosWrapper" aria-live="polite"></div>

  <h2 class="section-title" style="color:#00e690;margin-top:36px">üåê Translated Videos</h2>
  <div id="translatedList" aria-live="polite"></div>
</main>

<div class="overlay" id="overlay" aria-hidden="true">
  <div style="color:white;text-align:center;">
    <div style="font-size:24px;">‚è≥ Processing...</div>
    <p id="loaderSubtext" style="margin-top:8px;color:#ccc">Please wait...</p>
  </div>
</div>

<div id="notification" class="notification" role="status" aria-live="polite"></div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
(() => {
  const API = "http://127.0.0.1:5001";
  const socket = io(API);

  const overlay = document.getElementById("overlay");
  const notif = document.getElementById("notification");

  function showLoader(text){
    document.getElementById("loaderSubtext").textContent = text || "Please wait...";
    overlay.classList.add("show");
  }
  function hideLoader(){ overlay.classList.remove("show"); }

  function notify(msg, type="success"){
    notif.textContent = msg;
    notif.style.background = (type === "error") ? "#ff4757" : "#00b894";
    notif.classList.add("show");
    setTimeout(()=> notif.classList.remove("show"), 2600);
  }

  function safeId(s){ return (s||"").replace(/[^a-z0-9]/gi,"_").toLowerCase(); }

  /* ---------- load videos and render using safe DOM methods ---------- */
  async function loadVideos(){
    try {
      const res = await fetch(API + "/videos");
      if (!res.ok) throw new Error("Server returned " + res.status);
      const data = await res.json();

      renderOriginals(data.original_videos || []);
      renderTranslated(data.translated_videos || []);
    } catch (e) {
      console.error("loadVideos error:", e);
      notify("Failed to load videos", "error");
    }
  }

  function renderOriginals(list){
    const cont = document.getElementById("originalVideosWrapper");
    cont.innerHTML = "";
    for (const v of list){
      const id = safeId(v.filename);
      const card = document.createElement("div");
      card.className = "card";

      const vid = document.createElement("video");
      vid.src = API + v.src;
      vid.controls = true;

      const controls = document.createElement("div");
      controls.className = "controls";

      const sel = document.createElement("select");
      sel.id = "lang_" + id;
      sel.innerHTML = `<option value="">Lang</option>` + (v.available_langs || []).map(l => `<option value="${l}">${l.toUpperCase()}</option>`).join("");

      const btn = document.createElement("button");
      btn.className = "translate";
      btn.textContent = "Translate";
      btn.addEventListener("click", ()=> translateVideo(v.filename));

      controls.appendChild(sel);
      controls.appendChild(btn);

      card.appendChild(vid);
      card.appendChild(controls);
      cont.appendChild(card);
    }
  }

  function renderTranslated(list){
    const cont = document.getElementById("translatedList");
    cont.innerHTML = "";
    for (const v of list){
      const sid = safeId(v.filename);
      const url = API + v.src;

      const card = document.createElement("div");
      card.className = "card translated-card";
      card.dataset.filename = v.filename;

      // dots (bottom-right)
      const dots = document.createElement("div");
      dots.className = "dots";
      dots.tabIndex = 0;
      dots.role = "button";
      dots.title = "Open menu";
      dots.textContent = "‚ãÆ";
      dots.addEventListener("click", (ev) => {
        ev.stopPropagation();
        toggleMenuFor(sid);
      });
      dots.addEventListener("keydown", (ev) => { if (ev.key === "Enter") { ev.preventDefault(); toggleMenuFor(sid); } });

      // menu box
      const menu = document.createElement("div");
      menu.className = "menu-box";
      menu.id = "menu_" + sid;

      const miDownload = document.createElement("div");
      miDownload.className = "menu-item";
      miDownload.innerHTML = "‚¨á Download";
      miDownload.addEventListener("click", (ev)=> { ev.stopPropagation(); downloadVideo(url, v.filename); closeAllMenus(); });

      const miSpeed = document.createElement("div");
      miSpeed.className = "menu-item";
      miSpeed.innerHTML = "‚è± Playback speed";
      miSpeed.addEventListener("click", (ev)=> { ev.stopPropagation(); openSpeedMenu(sid); });

      const miDelete = document.createElement("div");
      miDelete.className = "menu-item";
      miDelete.innerHTML = "üóë Delete";
      miDelete.addEventListener("click", async (ev)=> {
        ev.stopPropagation();
        await deleteVideo(v.filename);
        closeAllMenus();
      });

      menu.appendChild(miDownload);
      menu.appendChild(miSpeed);
      menu.appendChild(miDelete);

      // speed submenu
      const sub = document.createElement("div");
      sub.className = "submenu";
      sub.id = "speed_" + sid;
      sub.innerHTML = `
        <div class="menu-item" data-speed="0.5">0.5x</div>
        <div class="menu-item" data-speed="1">1x Normal</div>
        <div class="menu-item" data-speed="1.5">1.5x</div>
        <div class="menu-item" data-speed="2">2x</div>
      `;
      sub.querySelectorAll(".menu-item").forEach(mi => {
        mi.addEventListener("click", (ev) => {
          ev.stopPropagation();
          const sp = parseFloat(mi.dataset.speed || "1");
          setSpeed(sid, sp);
          closeAllMenus();
        });
      });

      // video element with id for speed set
      const vid = document.createElement("video");
      vid.id = "vid_" + sid;
      vid.src = url;
      vid.controls = true;

      const caption = document.createElement("div");
      caption.style.padding = "5px";
      caption.style.color = "#aaa";
      caption.textContent = v.filename;

      // assemble
      card.appendChild(dots);
      card.appendChild(menu);
      card.appendChild(sub);
      card.appendChild(vid);
      card.appendChild(caption);
      cont.appendChild(card);
    }
  }

  /* ---------- menu helpers ---------- */
  function toggleMenuFor(sid){
    closeAllMenus();
    const m = document.getElementById("menu_" + sid);
    if (!m) return;
    m.style.display = (m.style.display === "block") ? "none" : "block";
  }
  function openSpeedMenu(sid){
    closeAllMenus();
    const sub = document.getElementById("speed_" + sid);
    if (!sub) return;
    sub.style.display = "block";
  }
  function closeAllMenus(){
    document.querySelectorAll(".menu-box").forEach(x=> x.style.display = "none");
    document.querySelectorAll(".submenu").forEach(x=> x.style.display = "none");
  }
  document.addEventListener("click", (ev) => {
    // close only if click outside menu-box and not on a .dots
    let target = ev.target;
    if (target.closest && (target.closest(".menu-box") || target.classList.contains("dots") || target.closest(".submenu"))) {
      return; // click inside menu or on dots ‚Äî do nothing
    }
    closeAllMenus();
  });

  /* ---------- actions ---------- */
  function downloadVideo(url, fname){
    // create <a> and click
    const a = document.createElement("a");
    a.href = url;
    a.download = fname;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function setSpeed(sid, speed){
    const vid = document.getElementById("vid_" + sid);
    if (vid) vid.playbackRate = speed;
    notify("Playback speed: " + speed + "x");
  }

  async function deleteVideo(filename){
    if (!confirm("Delete permanently?")) return;
    try {
      const res = await fetch(API + "/delete-video", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ filename: filename, type: "translated" })
      });
      const data = await res.json();
      if (data.success) {
        notify("Deleted");
        await loadVideos();
      } else {
        notify(data.message || "Delete failed", "error");
      }
    } catch (e) {
      console.error("deleteVideo error:", e);
      notify("Delete failed", "error");
    }
  }

  /* ---------- translate flow ---------- */
  async function translateVideo(name){
    const id = safeId(name);
    const sel = document.getElementById("lang_" + id);
    const lang = sel ? sel.value : "";
    if (!lang) { notify("Select a language", "error"); return; }

    showLoader("Generating audio & merging...");
    try {
      const res = await fetch(API + "/translate-video", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ video_name: name, target_lang: lang, socket_sid: socket.id })
      });
      const data = await res.json().catch(()=>null);
      // server responds with accepted ‚Äî actual progress comes via socket
      // we keep loader open until socket says done/error
      if (!res.ok) {
        hideLoader();
        notify("Translate request failed", "error");
      } else {
        notify("Translation started‚Ä¶", "success");
      }
    } catch (e) {
      hideLoader();
      console.error("translateVideo error:", e);
      notify("Translate request failed", "error");
    }
  }

  socket.on("translate-progress", (msg) => {
    try {
      if (!msg) return;
      if (msg.status === "done") {
        hideLoader();
        notify("‚úÖ Video translated");
        loadVideos();
      } else if (msg.status === "error") {
        hideLoader();
        notify(msg.message || "Translation error", "error");
      } else {
        // intermediate update
        document.getElementById("loaderSubtext").textContent = (msg.detail || msg.status || "");
      }
    } catch (e) { console.error(e); }
  });

  /* ---------- mic translate ---------- */
  function attachMicHandler(){
    const micBtn = document.getElementById("micBtn");
    const micSelect = document.getElementById("micLangSelect");
    if (!micBtn || !micSelect) return;
    micBtn.addEventListener("click", async () => {
      // request mic, record ~4 seconds (non-blocking)
      const target = micSelect.value || "hi";
      notify("üé§ Recording 4s...");
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const recorder = new MediaRecorder(stream);
        const parts = [];
        recorder.ondataavailable = (e) => parts.push(e.data);
        recorder.onstop = () => {
          const blob = new Blob(parts, { type: "audio/webm" });
          const reader = new FileReader();
          reader.onloadend = () => {
            showLoader("Sending audio for transcription...");
            socket.emit("mic-translate", { audio_b64: reader.result, target_lang: target });
          };
          reader.readAsDataURL(blob);
        };
        recorder.start();
        setTimeout(()=> recorder.stop(), 4000);
      } catch (err) {
        console.error("mic error:", err);
        notify("Mic access denied", "error");
      }
    });

    socket.on("mic-translate-result", (msg) => {
      hideLoader();
      if (!msg) { notify("Mic translation failed", "error"); return; }
      if (!msg.success) {
        notify(msg.error || "Mic translation failed", "error");
        return;
      }
      notify("üéâ Mic translated");
      // play TTS if present
      if (msg.audio_url) {
        const audio = new Audio(API + msg.audio_url);
        audio.play();
      } else if (msg.translated) {
        console.log("Translated text:", msg.translated);
      }
    });
  }

  /* ---------- socket connect error ---------- */
  socket.on("connect_error", () => notify("Socket connect failed", "error"));
  socket.on("connect", () => console.log("socket connected"));

  /* ---------- init ---------- */
  document.addEventListener("DOMContentLoaded", async () => {
    await loadVideos();
    attachMicHandler();
  });

  // expose for debugging (optional)
  window.__app = { loadVideos };

})();
</script>
</body>
</html>
